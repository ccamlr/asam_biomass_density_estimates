---
title: "ASAM Metadata 2021 Krill Biomass Estimate"
author: "Tracey Dornan"
date: "09/06/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)

library(data.table, quietly = TRUE)
library(knitr, quietly = TRUE)
library(ggplot2, quietly = TRUE)

```

# Krill biomass estimates from ASAM 2021 metadata

This Rmarkdown scripts works with a reduced version of the ASAM 2021 metadata spreadsheet, generated by "ASAM_2021_BiomassSummaryStats.Rmd".  In summary, the original metadata spreadsheet was:  
 
 1. formatted to be R friendly
 2. cleaned of duplicated data
 3. cleaned of data with missing values of Density, CV or Area required in calculations
 
 
This script reads in the cleaned data file *"ASAM_metadata_2021_v3_reduced.csv"* and restricts data to area 48.1 only. 
 

```{r load data}

filepath <- "C:/Onedrive/OneDrive - NERC/Documents_main/CCAMLR/CCAMLR_2021_Meeting/WG-ASAM_2021/BiomassEstimateWG/"

mdat <- fread(paste0(filepath, "ASAM_metadata_2021_v3_reduced.csv"))

unique(mdat$Subarea)

dt <- mdat[Subarea %in% c("48.1", "48.1/48.2")]

```
 
 
### Years & Months available for 48.1 data:

```{r yrs, include=TRUE}
sort(unique(dt$Year_yyyy))

dt$Month_MON <- factor(dt$Month_MON)

print(levels(dt$Month_MON) )
```
 
  
### Strata available


```{r strata_sort}

unique(dt$Stratum_name)

# unique(dt$strata)

dt <- dt[Stratum_name=="entire survey area", strata:="WESJ"][Stratum_name=="SSI", strata:="With_AP_is_WESJ"][Stratum_name=="South Shetland Islands North", strata:="W"][Stratum_name=="AP", strata:="WE"]
```
 
Strata which did not have a strata code already identified have been assigned one based on the closest area they resemble. 
 

```{r strata_table, include=TRUE}

knitr::kable(dt[, .(Number_surveys= as.character(.N),
                    strata_code=unique(strata),
                    Min_Area = round(min(Survey_area_km2)),
                    Max_Area = round(max(Survey_area_km2)),
                    Mean_Area =  round(mean(Survey_area_km2))),
                    by=Stratum_name
                ])
```
 

## Biomass calculations

### Strategy

The data will be assessed sequentially starting at the smallest strata combining all data within each of "E", "W", "S", "J" . 
 
Then combining all data with "WE" codes and finally combining all in the large scale full area "WESJ".

**NOTE: the 2019 synoptic survey was aggregated over "Dec,Jan,Feb,Mar" & data available broadly spans months of Dec-Mar.** 

 April is represented by a single 2018 survey carried out on *Polarstern*. In addition the CV were simply calculated as the S.E/Mean x 100% for each stratum or entire survey area,  which covered: 
 * South Shetland Islands North - W
 * Elephant Island - E
 * Bransfield - S
 * Joinville - J
 * entire survey area - WESJ
 
 
 August data was all collected by the *Nathaniel B. Palmer* in `r unique(dt[Vessel=="Nathaniel B. Palmer"]$Year_yyyy)`

 
**Given the available data, summary stats are initially being calculated for the combined months of "December, January, February and March" data only.**



### Methodology

**1) identify the various surveys that will be included in computing an average**  
  
**2) compute weighted mean density using the survey areas as weights**


  * TotalArea <- sum(Survey_area_km2)  
  
  * AreaWeighting := Survey_area_km2/TotalArea  
  
  * Mean_Wt_Density_gm2 <- weighted.mean(x =Density_gm2, w = AreaWeighting)  
  


since CVs are reported in the metadata spreadsheet these need to be converted to variances for use in the next step as  
variance of survey density = (reported CV * reported density)^2^

  - Var_Density := (Density_gm2 * (CV_of_density_Perc / 100) )^2


**3) compute the variance of the weighted mean density using equation 3 in Jolly and Hampton (1990)**

![ ](images/JH1990_Eq3.png)

  * JH_Numerator := (Survey_area_km2^2 * Var_Density)  
  * Var_WtMeanDensity <- (sum(tmpdt$JH_Numerator)) / (TotalArea)^2
    
**4) CV = sqrt of variance from step 3 / mean from step 2**  
  
  * CV <- (sqrt(Var_WtMeanDensity) / Mean_Wt_Density_gm2)*100  
    
    
**5) compute extrapolated biomass estimate as mean from step 2 * area to which extrapolation applies** 

(in Tonnes Per Square Kilometer (t/km2))

  * biomass_extra <- Mean_Wt_Density_gm2 * mean_strata_area  
  
  
**6) compute variance of estimate from step 5 as variance from step 3 * (area to which extrapolation applies)^2^**  
  
  * var_biomass_extra <- Var_WtMeanDensity *(mean_strata_area^2)
  
**7) CV = sqrt of variance from step 6 / biomass estimate from step 5**  
  
  * CV_of_TotalBiomass <- (sqrt(var_biomass_extra) / biomass_extra)*100


Notes:
•	Steps 2-3 of this pseudocode can be applied to multiple surveys within a single stratum, surveys that cover multiple strata, or any combination of both.
•	Steps 3 and 6 aren't necessary but the results of those two should be equal and provide a nice double-check that everything is working OK.
•	For those interested in application to the Grym later on - the outcome from Step 7 (or Step 4) might yield a useful estimate of the parameter "B0logSD," where B0logSD = sqrt(log(1+CV^2))

  
```{r filter codes, echo=FALSE}

#set up factors
cols <- c("Vessel", "Contributor", "Subarea", "CV_method", "TS_model", "Time_sampled", "strata")

dt[,(cols) := lapply(.SD, as.factor), .SDcols = cols] 

Dec_Mar <-c("Dec", "Dec,Jan,Feb,Mar", "Feb", "Jan", "Jan,Feb", "Mar") # "Apr", "Aug"
all_months <- c("Dec", "Dec,Jan,Feb,Mar", "Feb", "Jan", "Jan,Feb", "Mar", "Apr", "Aug")


years_available <- sort(unique(dt$Year_yyyy), decreasing = TRUE)

y3 <- years_available[1:3]

y5 <- years_available[1:5]

y5107 <- c(2020,2019,2018,2016,2015,2014,2013,2012,2011,2010,2009)

yall <- years_available

yr_scenario <- list(y3=y3, y5=y5, y5107=y5107, yall=yall)

dt2 <- dt[Month_MON %in% Dec_Mar]
```

  
Step 1 - working by area  

**Year codes**
    
    y3 =  2020 2019 2018

    y5 = 2020 2019 2018 2016 2015

    y5107 = 2020 2019 2018 2016 2015 2014 2013 2012 2011 2010 2009

    yall = All available =  2020 2019 2018 2016 2015 2014 2013 2012 2011 2010 2009 2008 2007 2006 2005 2004 2003 2002 2001 2000 1999 1998 1997 1996
> 

### Joinville  
 
 Years available: `r unique(dt[strata=="J"]$Year_yyyy)` 
 
 Mean Joinville survey area from all data in analysis: `r format(round(mean(dt[strata=="J"]$Survey_area_km2), digits=0), scientific=F)`km^2^ for extrapolation

```{r joinville, echo=FALSE, include=TRUE}

st_name <- "Joinville"
st_name

mean_strata_area <- mean(dt[strata=="J"]$Survey_area_km2)
mean_strata_area

subdt <- dt2[strata=="J" ]

subdtsum <- NULL

for(i in 1:length(yr_scenario)){
  tmpyr <- yr_scenario[[i]]
  yrcode <- names(yr_scenario[i])
  tmpdt <- subdt[Year_yyyy %in% tmpyr]
  
  # STEP 2) compute weighted mean density using the survey areas as weights
  
  TotalArea <- sum(tmpdt$Survey_area_km2)
  
  tmpdt <- tmpdt[, AreaWeighting := Survey_area_km2/TotalArea]
  
  Mean_Wt_Density_gm2 <- weighted.mean(x = tmpdt$Density_gm2, w = tmpdt$AreaWeighting)
  
  # Calculate Variance of survey density
  
 tmpdt <- tmpdt[, Var_Density := (Density_gm2*(CV_of_density_Perc/100))^2]
 
 
 # STEP 3) compute the variance of the weighted mean density using equation 3 in Jolly and Hampton (1990)
 
 tmpdt <- tmpdt[, JH_Numerator := (Survey_area_km2^2 * Var_Density)]
 
 Var_WtMeanDensity <- (sum(tmpdt$JH_Numerator)) / (TotalArea)^2
 
# STEP 4) CV = sqrt of variance from step 3 / mean from step 2

 CV <- (sqrt(Var_WtMeanDensity) / Mean_Wt_Density_gm2)*100
 
 # STEP 5) compute extrapolated biomass estimate as mean from step 2 * area to which extrapolation applies
 
 biomass_extra <- Mean_Wt_Density_gm2 * mean_strata_area
 
 # STEP 6) compute variance of estimate from step 5 as variance from step 3 * (area to which extrapolation applies)^2
 
 var_biomass_extra <- Var_WtMeanDensity *(mean_strata_area^2)

 # STEP 7) CV = sqrt of variance from step 6 / biomass estimate from step 5
 
 CV_of_TotalBiomass <- (sqrt(var_biomass_extra) / biomass_extra)*100
 
 tmpstats <- as.data.frame(cbind(Strata= st_name, 
                                 N_surveys = nrow(tmpdt), 
                                 Wt_mean_Density_gm2 = round(Mean_Wt_Density_gm2, digits=2),
                                 Var_Wt_mean_Density = round(Var_WtMeanDensity, digits=2),
                                 CV_Wt_mean_Density_Perc = round(CV, digits=2),
                                 Total_Mean_Area = round(mean_strata_area, digits=2),
                                 Biomass_Tonnes_km2 = round(biomass_extra, digits = 2),
                                 Years_included = yrcode))
 
 subdtsum <- rbind(subdtsum, tmpstats)
 
 }

  
 kable(subdtsum) 
```


